Four fixes across `client/src/pages/trip-edit.tsx` and `server/storage.ts`. No schema changes.

---

## Fix 1 — Duplication preserves journey links, variants, and property groups (`server/storage.ts`)

**Root cause:** `duplicateTripVersion` calls `createTripSegment` for each segment but omits `journeyId`, `hasVariants`, and `propertyGroupId`. Duplicated versions lose connecting flight grouping, the "Options available" badge, and property group room grouping.

Find the `createTripSegment` call inside `duplicateTripVersion`. It currently looks like:

```typescript
await this.createTripSegment({
  versionId: newVersion.id,
  tripId,
  orgId,
  dayNumber: seg.dayNumber,
  sortOrder: seg.sortOrder,
  type: seg.type,
  title: seg.title,
  subtitle: seg.subtitle,
  startTime: seg.startTime,
  endTime: seg.endTime,
  confirmationNumber: seg.confirmationNumber,
  cost: seg.cost,
  currency: seg.currency,
  notes: seg.notes,
  photos: seg.photos,
  metadata: seg.metadata as Record<string, unknown> | null,
});
```

Add the three missing fields:

```typescript
await this.createTripSegment({
  versionId: newVersion.id,
  tripId,
  orgId,
  dayNumber: seg.dayNumber,
  sortOrder: seg.sortOrder,
  type: seg.type,
  title: seg.title,
  subtitle: seg.subtitle,
  startTime: seg.startTime,
  endTime: seg.endTime,
  confirmationNumber: seg.confirmationNumber,
  cost: seg.cost,
  currency: seg.currency,
  notes: seg.notes,
  photos: seg.photos,
  metadata: seg.metadata as Record<string, unknown> | null,
  journeyId: seg.journeyId,           // ADD — preserves connecting flight grouping
  hasVariants: seg.hasVariants,       // ADD — preserves "Options available" badge
  propertyGroupId: seg.propertyGroupId, // ADD — preserves property group rooms
});
```

Also copy variants. After the segment loop, add a loop to duplicate each segment's variants. The new segment IDs are needed — change the loop to collect an old→new ID map first:

```typescript
const segmentIdMap = new Map<string, string>(); // oldId → newId

for (const seg of sourceSegments) {
  const newSeg = await this.createTripSegment({
    versionId: newVersion.id,
    tripId,
    orgId,
    dayNumber: seg.dayNumber,
    sortOrder: seg.sortOrder,
    type: seg.type,
    title: seg.title,
    subtitle: seg.subtitle,
    startTime: seg.startTime,
    endTime: seg.endTime,
    confirmationNumber: seg.confirmationNumber,
    cost: seg.cost,
    currency: seg.currency,
    notes: seg.notes,
    photos: seg.photos,
    metadata: seg.metadata as Record<string, unknown> | null,
    journeyId: seg.journeyId,
    hasVariants: seg.hasVariants,
    propertyGroupId: seg.propertyGroupId,
  });
  segmentIdMap.set(seg.id, newSeg.id);
}

// Copy variants for each segment that has them
for (const [oldSegId, newSegId] of segmentIdMap) {
  const variants = await db.select().from(segmentVariants)
    .where(eq(segmentVariants.segmentId, oldSegId));
  for (const v of variants) {
    await db.insert(segmentVariants).values({
      segmentId: newSegId,
      tripId,
      orgId,
      label: v.label,
      description: v.description,
      cost: v.cost,
      currency: v.currency,
      quantity: v.quantity,
      pricePerUnit: v.pricePerUnit,
      refundability: v.refundability,
      refundDeadline: v.refundDeadline,
      variantType: v.variantType,
      isSelected: false,   // reset selection state on duplication
      isSubmitted: false,  // reset submission state on duplication
    });
  }
}
```

Make sure `segmentVariants` is imported at the top of `storage.ts` — it should already be since it's used elsewhere.

---

## Fix 2 — Position numbers count rendered items, not raw segments (`client/src/pages/trip-edit.tsx`)

**Root cause:** In the rendering loop, `positionInDay` is set to `daySegments.indexOf(item.segment) + 1`. But `daySegments` is the flat list of all segments including journey legs. A 2-leg journey occupies indices 0 and 1 as individual segments, so the next standalone segment gets position 3 instead of 2.

**Fix:** Compute position from the rendered items list, not the raw segments list.

Find the rendering loop. It currently calls `buildDayRenderItems(daySegments).map((item) => { ... })`. Change how `segIdx` (and therefore `positionInDay`) is derived:

Replace:
```tsx
{buildDayRenderItems(daySegments).map((item) => {
  // ...
  const segIdx = daySegments.indexOf(item.segment);
  return (
    <SegmentCard
      // ...
      positionInDay={segIdx + 1}
```

With:
```tsx
{buildDayRenderItems(daySegments).map((item, renderIdx) => {
  // ...
  return (
    <SegmentCard
      // ...
      positionInDay={renderIdx + 1}
```

`renderIdx` is the index in the rendered items array — journeys count as 1 item regardless of how many legs they have.

For `JourneyCard`, also pass `positionInDay={renderIdx + 1}` so it can display its position number. Add `positionInDay` as an optional prop to `JourneyCard`:

```typescript
function JourneyCard({
  legs,
  tripId,
  onEdit,
  trackingBySegment,
  showPricing,
  positionInDay,  // ADD
}: {
  legs: TripSegment[];
  tripId: string;
  onEdit: (s: TripSegment) => void;
  trackingBySegment: Map<string, FlightTracking>;
  showPricing?: boolean;
  positionInDay?: number;  // ADD
}) {
```

And render it in the `JourneyCard` header, before the plane icon, matching the same style as `SegmentCard`:

```tsx
<CardContent className="p-3 space-y-2">
  <div className="flex items-center gap-2">
    {positionInDay != null && (
      <div className="w-6 h-6 rounded-full bg-muted/50 text-[10px] font-medium text-muted-foreground shrink-0 flex items-center justify-center self-center">
        {positionInDay}
      </div>
    )}
    <div className="flex items-center justify-center w-9 h-9 rounded-md shrink-0 text-sky-600 bg-sky-50 dark:bg-sky-950/40">
```

Pass `positionInDay` at the call site:

```tsx
<JourneyCard
  key={`journey-${item.journeyId}`}
  legs={item.legs}
  tripId={id!}
  onEdit={openEditSegment}
  trackingBySegment={trackingBySegment}
  showPricing={showPricing}
  positionInDay={renderIdx + 1}  // ADD
/>
```

---

## Fix 3 — JourneyCard shows "Options available" badge, passengers, and cost breakdown (`client/src/pages/trip-edit.tsx`)

**Root cause:** `JourneyCard` renders no badge for `hasVariants` and shows no passenger count or per-unit cost. All of this information is available on `legs[0]`.

**In the `JourneyCard` header row** (the `<div className="flex items-center gap-2 flex-wrap">` line that shows the route and stops badge), add after the stops badge:

```tsx
{/* "Options available" badge — shown when the first leg has variants */}
{legs[0].hasVariants && (
  <Badge variant="secondary" className="text-[10px] shrink-0" data-testid={`badge-variants-journey-${legs[0].journeyId}`}>
    Options available
  </Badge>
)}
```

**In the row below the route** (the `<div className="flex items-center gap-2 text-xs text-muted-foreground mt-0.5 flex-wrap">` that shows city names and total time), add after the time display:

```tsx
{(() => {
  const meta = (legs[0].metadata || {}) as Record<string, any>;
  const qty = meta.quantity || 1;
  const ppu = meta.pricePerUnit;
  const totalCost = legs.reduce((sum, leg) => sum + (leg.cost || 0), 0);
  const currency = legs[0].currency || "USD";
  if (qty <= 1 && !showPricing) return null;
  return (
    <>
      {qty > 1 && (
        <>
          <span className="text-muted-foreground/40">&middot;</span>
          <span>{qty} passengers</span>
        </>
      )}
      {showPricing && totalCost > 0 && (
        <>
          <span className="text-muted-foreground/40">&middot;</span>
          <span className="font-medium text-foreground/80">
            {currency} {totalCost.toLocaleString()}
          </span>
          {qty > 1 && (() => {
            const effectivePpu = ppu && ppu > 0 ? ppu : (totalCost > 0 ? Math.round(totalCost / qty) : null);
            return effectivePpu ? (
              <span className="text-muted-foreground/60">
                ({currency} {effectivePpu.toLocaleString()} × {qty})
              </span>
            ) : null;
          })()}
        </>
      )}
    </>
  );
})()}
```

---

## Fix 4 — SegmentCard shows passenger/room count and per-unit cost (`client/src/pages/trip-edit.tsx`)

**Root cause:** Individual flight and hotel `SegmentCard` entries show cost (when `showPricing` is on) but never show `quantity` or `pricePerUnit`.

**For flights** (`isCommercialFlight` block), add to `extraLines` after the existing entries:

```typescript
if (isCommercialFlight) {
  // ...existing lines...
  const qty = meta.quantity || 1;
  const ppu = meta.pricePerUnit;
  if (qty > 1) {
    const currency = segment.currency || "USD";
    const cost = segment.cost || 0;
    const effectivePpu = ppu && ppu > 0 ? ppu : (cost > 0 ? Math.round(cost / qty) : null);
    if (effectivePpu) {
      extraLines.push(`${qty} passengers · ${currency} ${effectivePpu.toLocaleString()} / passenger`);
    } else {
      extraLines.push(`${qty} passengers`);
    }
  }
}
```

**For hotels** (`segment.type === "hotel"` block), add to `extraLines` after room type and address:

```typescript
} else if (segment.type === "hotel") {
  // ...existing lines...
  const qty = meta.quantity || 1;
  const ppu = meta.pricePerUnit;
  if (qty > 1) {
    const currency = segment.currency || "USD";
    const cost = segment.cost || 0;
    const effectivePpu = ppu && ppu > 0 ? ppu : (cost > 0 ? Math.round(cost / qty) : null);
    if (effectivePpu) {
      extraLines.push(`${qty} rooms · ${currency} ${effectivePpu.toLocaleString()} / room`);
    } else {
      extraLines.push(`${qty} rooms`);
    }
  }
}
```

These lines appear in the `extraLines` array which is rendered as small grey text below the main content of each card — always visible, no hover required.